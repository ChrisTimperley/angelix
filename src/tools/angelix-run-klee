#!/bin/bash

exe="$1"
shift

rm -rf "$ANGELIX_KLEE_WORKDIR"/klee-out-*
rm -rf "$(dirname "$exe")"/klee-out-*

export ANGELIX_SYMBOLIC_RUNTIME=ON

klee -write-smt2s \
     -smtlib-human-readable \
     --libc=uclibc \
     --posix-runtime \
     -allow-external-sym-calls \
     -max-forks=$ANGELIX_KLEE_MAX_FORKS \
     -max-time=$ANGELIX_KLEE_MAX_TIME \
     -max-solver-time=$ANGELIX_KLEE_MAX_SOLVER_TIME \
     "${exe}.patched.bc" \
     "$@" \
     &> "$ANGELIX_KLEE_WORKDIR/last-klee-log.txt"

mv "$(dirname "$exe")"/klee-out-* "$ANGELIX_KLEE_WORKDIR"

# it makes sence to return 0 so that the test can proceed
exit 0
